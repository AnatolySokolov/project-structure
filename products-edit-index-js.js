(window.webpackJsonp=window.webpackJsonp||[]).push([[4],{12:function(e,t,n){"use strict";function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,"a",(function(){return i}));class i{constructor(e=[]){s(this,"element",void 0),s(this,"onDocumentPointermove",({clientX:e,clientY:t})=>{this.moveDraggingAt(e,t),this.draggingItem.style.zIndex=-1;const n=document.elementFromPoint(e,t);if(this.draggingItem.style.zIndex=1e4,!n.classList.contains("sortable-list__item"))return;const{top:s}=n.getBoundingClientRect(),{offsetHeight:i}=n;t<s+i/2?n.before(this.placeholder):n.after(this.placeholder)}),s(this,"onDocumentPointerup",()=>{this.dragStop()}),this.items=e,this.render()}render(){this.element=document.createElement("ul"),this.element.classList.add("sortable-list"),this.items.forEach(e=>e.classList.add("sortable-list__item")),this.element.append(...this.items),this.element.addEventListener("pointerdown",e=>this.onPointerdown(e))}onPointerdown(e){const t=e.target.closest(".sortable-list__item");t&&(e.preventDefault(),e.target.closest("[data-grab-handle")&&this.dragStart(e,t),e.target.closest("[data-delete-handle]")&&t.remove())}dragStart({clientX:e,clientY:t},n){this.initialIndex=[...this.element.children].indexOf(n),this.initialShift={x:e-n.getBoundingClientRect().x,y:t-n.getBoundingClientRect().y},this.draggingItem=n,this.placeholder=document.createElement("div"),this.placeholder.classList.add("sortable-list__placeholder"),n.style.width=n.offsetWidth+"px",n.style.height=n.offsetHeight+"px",this.placeholder.style.width=n.style.width,this.placeholder.style.height=n.style.height,n.classList.add("sortable-list__item_dragging"),n.after(this.placeholder),this.element.append(n),this.moveDraggingAt(e,t),document.addEventListener("pointermove",this.onDocumentPointermove),document.addEventListener("pointerup",this.onDocumentPointerup)}moveDraggingAt(e,t){this.draggingItem.style.left=e-this.initialShift.x+"px",this.draggingItem.style.top=t-this.initialShift.y+"px"}dragStop(){const e=[...this.element.children].indexOf(this.placeholder);this.placeholder.replaceWith(this.draggingItem),this.draggingItem.classList.remove("sortable-list__item_dragging"),this.draggingItem.style.left="",this.draggingItem.style.top="",this.draggingItem.style.width="",this.draggingItem.style.height="",this.draggingItem=null,e!==this.initialIndex&&this.element.dispatchEvent(new CustomEvent("sortable-list-reorder",{bubbles:!0,detail:{from:this.initialIndex,to:e}})),document.removeEventListener("pointermove",this.onDocumentPointermove),document.removeEventListener("pointerup",this.onDocumentPointerup)}remove(){this.element.remove()}destroy(){this.remove(),document.removeEventListener("pointermove",this.onDocumentPointermove),document.removeEventListener("pointerup",this.onDocumentPointerup)}}},13:function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));class s{constructor(e="",{duration:t=2e3,type:n="success"}={}){s.element&&s.element.remove(),this.message=e,this.duration=t,this.durationInSeconds=Math.floor(t/1e3)+"s",this.type=n,this.render()}get template(){return`\n      <div class="notification notification_${this.type} show" style="--value:${this.duration/1e3}s">\n        <div class="notification__content">\n          ${this.message}\n        </div>\n      </div>\n    `}render(){const e=document.createElement("div");e.innerHTML=this.template,this.element=e.firstElementChild,s.element=this.element}show(e=document.body){e.append(this.element),setTimeout(()=>this.remove(),this.duration)}remove(){this.element.remove()}destroy(){this.remove(),s.element=null}}var i,r,o;o=null,(r="element")in(i=s)?Object.defineProperty(i,r,{value:o,enumerable:!0,configurable:!0,writable:!0}):i[r]=o},5:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return c}));var s=n(12),i=e=>e.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),r=n(9);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class a{constructor(e){o(this,"element",void 0),o(this,"subElements",{}),o(this,"url",new URL("api/rest/products","https://course-js.javascript.ru/")),o(this,"upload",async()=>{const[e]=this.subElements.productForm.upload.files,t=new FormData,n={source:e.name};t.append("image",e);try{const e=await Object(r.a)("https://api.imgur.com/3/image",{method:"POST",headers:{Authorization:"Client-ID 28aaa2e823b03b1"},body:t}),{data:s}=await e;n.url=s.link;const i=this.getImageElement(n);i.classList.add("sortable-list__item"),this.subElements.imageListContainer.querySelector(".sortable-list").append(i)}catch(e){console.error(e)}}),o(this,"onUploadImageClick",()=>{this.subElements.upload.click()}),o(this,"onFormSubmit",async e=>{e.preventDefault();let t,n;await Object(r.a)(this.url,{method:this.productId?"PATCH":"PUT",headers:{"Content-Type":"application/json;charset=utf-8"},body:JSON.stringify(this.getFormElementsData())})?(t="successful-form-confirmation",n=this.productId?"product-updated":"product-saved"):t="error-from-confirmation",this.element.dispatchEvent(new CustomEvent(t,{bubbles:!0,detail:n}))}),this.productId=e,this.renderForm(),this.addListeners()}get template(){return`\n      <div class="product-form">\n        <form data-element="productForm" class="form-grid">\n\n          <div class="form-group form-group__half_left">\n            ${this.createFieldset("Product name","title","text","Product name",!0)}\n          </div>\n\n          <div class="form-group form-group__wide">\n            <label class="form-label">Description</label>\n            <textarea required="" class="form-control" name="description"\n            data-form="description" placeholder="Product description"></textarea>\n          </div>\n\n          <div class="form-group form-group__wide" data-element="sortable-list-container">\n            <label class="form-label">Images</label>\n            <div data-element="imageListContainer"></div>\n            <button type="button" name="uploadImage" class="button-primary-outline"><span>Upload</span></button>\n            <input data-element="upload" name="upload" type="file" hidden>\n          </div>\n\n          <div class="form-group form-group__half_left">\n            <label class="form-label">Category</label>\n            <select id="subcategory" data-form="subcategory" class="form-control" name="subcategory">              \n            </select>\n          </div>\n\n          <div class="form-group form-group__half_left form-group__two-col">\n            ${this.createFieldset("Price ($)","price","number","100",!0)}\n            ${this.createFieldset("Discount ($)","discount","number","0",!0)}\n          </div>\n\n          <div class="form-group form-group__part-half">\n            <label class="form-label">Quantity</label>\n            <input data-form="quantity" required="" type="number" class="form-control" name="quantity" placeholder="1">\n          </div>\n\n          <div class="form-group form-group__part-half">\n            <label class="form-label">Status</label>\n            <select data-form="status" class="form-control" name="status">\n              <option value="1">Active</option>\n              <option value="0">Inactive</option>\n            </select>\n          </div>\n\n          <div class="form-buttons">\n            <button type="submit" name="save" class="button-primary-outline">\n              Save product\n            </button>\n          </div>\n\n        </form>\n      </div>\n    `}createFieldset(e="",t="",n="text",s="",i=!1){return`\n      <fieldset>\n        <label class="form-label">${e}</label>\n        <input\n          data-form="${t}"\n          class="form-control"\n          name="${t}"\n          type="${n}"\n          placeholder="${s}"\n          required="${i}">\n      </fieldset>\n    `}getImageElement(e={}){const t=document.createElement("div");return t.innerHTML=`\n      <li class="products-edit__imagelist-item" style="">\n        <input type="hidden" name="url" value="${e.url}">\n        <input type="hidden" name="source" value="${e.source}">\n        <span>\n          <img src="/images/icon-grab.svg" data-grab-handle="" alt="grab">\n          <img class="sortable-table__cell-img" alt="Image" src="${i(e.url)}">\n          <span>${i(e.source)}</span>\n        </span>\n        <button type="button">\n          <img src="/images/icon-trash.svg" data-delete-handle="" alt="delete">\n        </button>\n      </li>\n    `,t.firstElementChild}renderImages(e){const t=e.map(e=>this.getImageElement(e)),n=new s.a(t);this.subElements.imageListContainer.append(n.element)}renderForm(){const e=document.createElement("div");e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(this.element)}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}getOptions(e=[]){return e.map(e=>e.subcategories.map(t=>`<option value="${t.id}">${e.title} &gt; ${t.title}</option>`).join("")).join("")}renderCategories(e=[]){const t=this.getOptions(e);this.subElements.productForm.subcategory.innerHTML=t}async render(){if(this.productId){const e=Object(r.a)("https://course-js.javascript.ru/api/rest/categories?_sort=weight&_refs=subcategory"),t=this.loadProductById(this.productId),[n,s]=await Promise.all([e,t]);n&&this.renderCategories(n),s&&this.update(...s)}else{const e=await Object(r.a)("https://course-js.javascript.ru/api/rest/categories?_sort=weight&_refs=subcategory");e&&this.renderCategories(e)}return this.element}async loadProductById(e){const t=new URL(this.url);return t.searchParams.set("id",e),await Object(r.a)(t)}setCategory(e){const t=this.subElements.productForm.subcategory,n=Array.from(t.options).find(t=>t.value===e);n&&(n.selected=!0)}update(e={}){this.subElements.productForm.title.value=e.title,this.subElements.productForm.description.value=e.description,this.setCategory(e.subcategory),this.subElements.productForm.price.value=e.price,this.subElements.productForm.discount.value=e.discount,this.subElements.productForm.quantity.value=e.quantity,this.subElements.productForm.status.value=e.status,this.renderImages(e.images)}getFormElementsData(){const e={},t=this.element.querySelectorAll("[data-form]"),n=["price","quantity","discount","status"];[...t].forEach(t=>{n.includes(t.name)?e[t.name]=Number(t.value):e[t.name]=t.value});const s=this.element.querySelectorAll('[name="url"]'),i=this.element.querySelectorAll('[name="source"]');return e.images=[],[...s].forEach((t,n)=>{e.images.push({url:t.value,source:i[n].value})}),this.productId&&(e.id=this.productId),e}addListeners(){this.subElements.upload.addEventListener("change",this.upload),this.subElements.productForm.uploadImage.addEventListener("click",this.onUploadImageClick),this.subElements.productForm.addEventListener("submit",this.onFormSubmit)}remove(){this.element.remove()}destroy(){this.remove(),this.subElements=null}}var l=n(13);function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class c{constructor(e){d(this,"element",void 0),d(this,"subElements",{}),d(this,"components",{}),this.productId=e}get template(){return'\n\t\t\t<div class="products-edit">\n\n\t\t\t\t<div class="content__top-panel">\n\t\t\t\t\t<h1 class="page-title">\n\t\t\t\t\t\t<a href="/products" class="link">Products</a>\n\t\t\t\t\t\t\t/ Add\n\t\t\t\t\t</h1>\n\t\t\t\t</div>\n\n\t\t\t\t<div data-element="productForm" class="content-box"></div>\n\n\t\t\t</div>\n\t\t'}render(){const e=document.createElement("div");return e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(this.element),this.initComponents(),this.renderComponents(),this.initEventListeners(),this.element}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}initComponents(){const e=new a(this.productId);this.components={productForm:e}}async renderComponents(){const e=await this.components.productForm.render();this.subElements.productForm.append(e)}initEventListeners(){this.components.productForm.element.addEventListener("successful-form-confirmation",e=>{const t=e.detail;new l.a(t).show()})}remove(){this.element.remove()}destroy(){this.remove()}}},9:function(e,t,n){"use strict";t.a=async function(e,t){let n,i;try{n=await fetch(e.toString(),t)}catch(e){throw new s(n,"Network error has occurred.")}if(!n.ok){let e=n.statusText;try{i=await n.json(),e=i.error&&i.error.message||i.data&&i.data.error&&i.data.error.message||e}catch(e){}let t=`Error ${n.status}: ${e}`;throw new s(n,i,t)}try{return await n.json()}catch(e){throw new s(n,null,e.message)}};class s extends Error{constructor(e,t,n){var s,i,r;super(n),r="FetchError",(i="name")in(s=this)?Object.defineProperty(s,i,{value:r,enumerable:!0,configurable:!0,writable:!0}):s[i]=r,this.response=e,this.body=t}}window.addEventListener("unhandledrejection",e=>{e.reason instanceof s&&alert(e.reason.message)})}}]);
//# sourceMappingURL=products-edit-index-js.js.map