(window.webpackJsonp=window.webpackJsonp||[]).push([[2],[,,,,function(e,t,s){"use strict";s.r(t),s.d(t,"default",(function(){return h}));var n=s(14),a=s(11),r=s(9);function i(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class l{constructor({label:e="",link:t="",formatHeading:s=(e=>e),url:n="",range:a={from:new Date,to:new Date}}={}){i(this,"element",void 0),i(this,"subElements",{}),i(this,"chartHeight",50),this.url=new URL(n,"https://course-js.javascript.ru/"),this.range=a,this.label=e,this.link=t,this.formatHeading=s,this.render()}render(){const{from:e,to:t}=this.range,s=document.createElement("div");s.innerHTML=this.template,this.element=s.firstElementChild,this.subElements=this.getSubElements(this.element),this.loadData(e,t)}getHeaderValue(e){return this.formatHeading(Object.values(e).reduce((e,t)=>e+t,0))}async loadData(e,t){this.element.classList.add("column-chart_loading"),this.subElements.header.textContent="",this.subElements.body.innerHTML="",this.url.searchParams.set("from",e.toISOString()),this.url.searchParams.set("to",t.toISOString());const s=await Object(r.a)(this.url);this.setNewRange(e,t),s&&Object.values(s).length&&(this.subElements.header.textContent=this.getHeaderValue(s),this.subElements.body.innerHTML=this.getColumnBody(s),this.element.classList.remove("column-chart_loading"))}setNewRange(e,t){this.range.from=e,this.range.to=t}getColumnBody(e){const t=Math.max(...Object.values(e));return Object.entries(e).map(([e,s])=>{const n=this.chartHeight/t,a=(s/t*100).toFixed(0),r=`<span>\n        <small>${e.toLocaleString("default",{dateStyle:"medium"})}</small>\n        <br>\n        <strong>${a}%</strong>\n      </span>`;return`<div style="--value: ${Math.floor(s*n)}" data-tooltip="${r}"></div>`}).join("")}getLink(){return this.link?`<a class="column-chart__link" href="${this.link}">View all</a>`:""}get template(){return`\n      <div class="column-chart dashboard__chart_${this.label} column-chart_loading" style="--chart-height: ${this.chartHeight}">\n        <div class="column-chart__title">\n          Total ${this.label}\n          ${this.getLink()}\n        </div>\n        <div class="column-chart__container">\n          <div data-element="header" class="column-chart__header"></div>\n          <div data-element="body" class="column-chart__chart"></div>\n        </div>\n      </div>\n    `}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}async update(e,t){return await this.loadData(e,t)}destroy(){this.element.remove()}}var o=s(10);var c=[{id:"images",title:"Image",sortable:!1,template:e=>`\n          <div class="sortable-table__cell">\n            <img class="sortable-table-image" alt="Image" src="${e[0].url}">\n          </div>\n        `},{id:"title",title:"Name",sortable:!0,sortType:"string"},{id:"subcategory",title:"Category",sortable:!1,template:e=>`<div class="sortable-table__cell">${e.title}</div>`},{id:"quantity",title:"Quantity",sortable:!0,sortType:"number"},{id:"price",title:"Price",sortable:!0,sortType:"number",template:e=>`<div class="sortable-table__cell">$${Object(o.a)(e,",")}</div>`},{id:"sales",title:"Sales",sortable:!0,sortType:"number"}];function d(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class h{constructor(){d(this,"element",void 0),d(this,"subElements",void 0),d(this,"components",void 0)}get template(){return'\n      <div class="dashboard full-height flex-column">\n\n        <div class="content__top-panel">\n          <h2 class="page-title">Dashboard</h2>\n          <div data-element="rangePicker"></div>\n        </div>\n\n        <div class="dashboard__charts">\n          <div data-element="ordersChart"></div>\n          <div data-element="salesChart"></div>\n          <div data-element="customersChart"></div>\n        </div>\n        <h3 class="block-title">Sales leaders</h3>\n        <div data-element="sortableTable"></div>\n\n      </div>\n    '}render(){const e=document.createElement("div");return e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(this.element),this.initComponents(),this.renderComponents(),this.initEventListeners(),this.element}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}initComponents(){const e={from:new Date((new Date).setMonth((new Date).getMonth()-1)),to:new Date},t=new n.a(e),s=new l({url:"api/dashboard/orders",range:e,label:"orders",link:"#"}),r=new l({url:"api/dashboard/sales",range:e,label:"sales",formatHeading:e=>"$"+Object(o.a)(e,",")}),i=new l({url:"api/dashboard/customers",range:e,label:"customers"}),d=new a.a(c,{url:`api/dashboard/bestsellers?from=${encodeURIComponent(e.from)}&to${encodeURIComponent(e.to)}`,step:30,start:1,isSortLocally:!0});this.components={rangePicker:t,ordersChart:s,salesChart:r,customersChart:i,sortableTable:d}}renderComponents(){for(const[e,t]of Object.entries(this.components)){this.subElements[e].append(t.element)}}async updateComponents(e,t){const s=this.components.sortableTable.url;s.searchParams.set("from",e),s.searchParams.set("to",t);const n=await Object(r.a)(s);this.components.sortableTable.update(n),this.components.ordersChart.update(e,t),this.components.salesChart.update(e,t),this.components.customersChart.update(e,t)}initEventListeners(){this.subElements.rangePicker.addEventListener("date-select",e=>{const{from:t,to:s}=e.detail;this.updateComponents(t,s)})}remove(){this.element.remove()}destroy(){this.remove();for(const e of Object.values(this.components))e.destroy()}}},,,,,function(e,t,s){"use strict";t.a=async function(e,t){let s,a;try{s=await fetch(e.toString(),t)}catch(e){throw new n(s,"Network error has occurred.")}if(!s.ok){let e=s.statusText;try{a=await s.json(),e=a.error&&a.error.message||a.data&&a.data.error&&a.data.error.message||e}catch(e){}let t=`Error ${s.status}: ${e}`;throw new n(s,a,t)}try{return await s.json()}catch(e){throw new n(s,null,e.message)}};class n extends Error{constructor(e,t,s){var n,a,r;super(s),r="FetchError",(a="name")in(n=this)?Object.defineProperty(n,a,{value:r,enumerable:!0,configurable:!0,writable:!0}):n[a]=r,this.response=e,this.body=t}}window.addEventListener("unhandledrejection",e=>{e.reason instanceof n&&alert(e.reason.message)})},function(e,t,s){"use strict";t.a=function(e,t){const s=String(e).split("");return s.length>3&&s.length<=6?s.splice(-3,0,t):s.length>6&&(s.splice(-3,0,t),s.splice(-7,0,t)),""+s.join("")}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(9);function a(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}class r{constructor(e=[],{url:t="",step:s=30,start:n=0,isSortLocally:r=!1}={}){a(this,"element",void 0),a(this,"subElements",{}),a(this,"data",[]),a(this,"sortParams",{}),a(this,"filterParams",{}),a(this,"isSortLocally",!1),a(this,"isRequestSend",!1),a(this,"onHeaderPointerdown",async e=>{const t=e.target.closest(".sortable-table__cell"),{id:s,order:n,sortable:a}=t.dataset;if("false"===a)return;const r={asc:"desc",desc:"asc"};t.dataset.order=r[n],t.append(this.subElements.arrow),this.sortParams._sort=s,this.sortParams._order=r[n],this.isSortLocally?this.sort(this.sortParams._sort,this.sortParams._order):this.sortOnServer()}),a(this,"onDocumentScroll",async()=>{if(this.isRequestSend||this.isSortLocally)return;const{bottom:e}=document.documentElement.getBoundingClientRect();if(e<document.documentElement.clientHeight+200){this.isRequestSend=!0,this.sortParams._start+=this.step,this.sortParams._end+=this.step;const e=await this.loadData();this.addRows(e),this.isRequestSend=!1}}),this.header=e,this.url=new URL(t,"https://course-js.javascript.ru/"),this.step=s,this.sortParams._sort=e.find(e=>e.sortable).id,this.sortParams._order="asc",this.sortParams._start=n,this.sortParams._end=n+s,this.isSortLocally=r,this.render(),this.addListeners()}get template(){return`\n      <div class="sortable-table">\n\n        <div data-element="header" class="sortable-table__header sortable-table__row">\n          ${this.getHeaderTemplate()}\n        </div>\n\n        <div data-element="body" class="sortable-table__body">\n          ${this.getBodyTemplate(this.data)}\n        </div>\n\n        <div data-element="loading" class="loading-line sortable-table__loading-line"></div>\n\n        <div data-element="emptyPlaceholder" class="sortable-table__empty-placeholder">\n          <div>\n            <p>No products found matching the selected criteria</p>\n            <button data-element="reset" type="button" class="button-primary-outline">Clear filters</button>\n          </div>\n        </div>\n\n      </div>\n    `}getHeaderTemplate(){return this.header.map(e=>this.getHeaderRowTemplate(e)).join("")}getHeaderRowTemplate({id:e,title:t,sortable:s}){return`\n      <div class="sortable-table__cell" data-id="${e}" data-sortable="${s}" ${s?'data-order="asc"':""}>\n        <span>${t}</span>\n        ${this.getHeaderArrowTemplate(e)}\n      </div>\n    `}getHeaderArrowTemplate(e){return e===this.sortParams._sort?'\n      <span data-element="arrow" class="sortable-table__sort-arrow">\n        <span class="sort-arrow"></span>\n      </span>\n    ':""}getBodyTemplate(e){return e.map(e=>`\n          <a href="/products/${e.id}" class="sortable-table__row">\n            ${this.getCellTemplate(e)}\n          </a>\n        `).join("")}getCellTemplate(e){return this.header.map(({id:t,template:s})=>"images"!==t||e[t].length?s?s(e[t]):`<div class="sortable-table__cell">${e[t]}</div>`:'\n            <div class="sortable-table__cell">\n              <img class="sortable-table-image" alt="no-image" src="#">\n            </div>\n          ').join("")}async render(){const e=document.createElement("div");e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(this.element);const t=await this.loadData();this.update(t)}getSubElements(e){return[...e.querySelectorAll("[data-element]")].reduce((e,t)=>(e[t.dataset.element]=t,e),{})}async loadData(e){this.element.classList.add("sortable-table_loading"),e&&(this.filterParams=e);const t=new URL(this.url),s=Object.assign({},this.filterParams,this.sortParams);for(const e of Object.keys(s))t.searchParams.set(e,s[e]);const a=await Object(n.a)(t);return this.element.classList.remove("sortable-table_loading"),a}update(e){e.length?(this.subElements.body.innerHTML=this.getBodyTemplate(e),this.data=e,this.element.classList.remove("sortable-table_empty")):this.element.classList.add("sortable-table_empty")}makeSort(e,t){const s=[...this.data],{sortType:n}=this.header.find(t=>t.id===e),a="asc"===t?1:-1;return s.sort((t,s)=>{switch(n){case"string":return a*t[e].localeCompare(s[e],["ru","en"],{caseFirst:"upper"});case"number":default:return a*(t[e]-s[e])}})}sort(e,t){const s=this.makeSort(e,t);this.subElements.body.innerHTML=this.getBodyTemplate(s)}async sortOnServer(){const e=await this.loadData();this.update(e)}addListeners(){this.subElements.header.addEventListener("click",this.onHeaderPointerdown),document.addEventListener("scroll",this.onDocumentScroll)}addRows(e){this.subElements.body.insertAdjacentHTML("beforeend",this.getBodyTemplate(e))}remove(){this.element.remove()}destroy(){this.remove(),this.subElements={},document.removeEventListener("scroll",this.onDocumentScroll)}}},,,function(e,t,s){"use strict";function n(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}s.d(t,"a",(function(){return a}));class a{static formatDate(e){return e.toLocaleString("ru",{dateStyle:"short"})}constructor({from:e=new Date,to:t=new Date}={}){n(this,"element",null),n(this,"subElements",{}),n(this,"selectingFrom",!0),n(this,"selected",{from:new Date,to:new Date}),n(this,"onDocumentClick",e=>{const t=this.element.classList.contains("rangepicker_open"),s=this.element.contains(e.target);t&&!s&&this.close()}),this.showDateFrom=new Date(e),this.selected={from:e,to:t},this.render()}get template(){return`<div class="rangepicker">\n      <div class="rangepicker__input" data-element="input">\n        <span data-element="from">${a.formatDate(this.selected.from)}</span> -\n        <span data-element="to">${a.formatDate(this.selected.to)}</span>\n      </div>\n      <div class="rangepicker__selector" data-element="selector"></div>\n    </div>`}render(){const e=document.createElement("div");e.innerHTML=this.template,this.element=e.firstElementChild,this.subElements=this.getSubElements(e),this.initEventListeners()}getSubElements(e){const t={};for(const s of e.querySelectorAll("[data-element]"))t[s.dataset.element]=s;return t}initEventListeners(){const{input:e,selector:t}=this.subElements;document.addEventListener("click",this.onDocumentClick,!0),e.addEventListener("click",()=>this.toggle()),t.addEventListener("click",e=>this.onSelectorClick(e))}toggle(){this.element.classList.toggle("rangepicker_open"),this.renderDateRangePicker()}onSelectorClick({target:e}){e.classList.contains("rangepicker__cell")&&this.onRangePickerCellClick(e)}close(){this.element.classList.remove("rangepicker_open")}renderDateRangePicker(){const e=new Date(this.showDateFrom),t=new Date(this.showDateFrom),{selector:s}=this.subElements;t.setMonth(t.getMonth()+1),s.innerHTML=`\n      <div class="rangepicker__selector-arrow"></div>\n      <div class="rangepicker__selector-control-left"></div>\n      <div class="rangepicker__selector-control-right"></div>\n      ${this.renderCalendar(e)}\n      ${this.renderCalendar(t)}\n    `;const n=s.querySelector(".rangepicker__selector-control-left"),a=s.querySelector(".rangepicker__selector-control-right");n.addEventListener("click",()=>this.prev()),a.addEventListener("click",()=>this.next()),this.renderHighlight()}prev(){this.showDateFrom.setMonth(this.showDateFrom.getMonth()-1),this.renderDateRangePicker()}next(){this.showDateFrom.setMonth(this.showDateFrom.getMonth()+1),this.renderDateRangePicker()}renderHighlight(){const{from:e,to:t}=this.selected;for(const s of this.element.querySelectorAll(".rangepicker__cell")){const{value:n}=s.dataset,a=new Date(n);s.classList.remove("rangepicker__selected-from"),s.classList.remove("rangepicker__selected-between"),s.classList.remove("rangepicker__selected-to"),e&&n===e.toISOString()?s.classList.add("rangepicker__selected-from"):t&&n===t.toISOString()?s.classList.add("rangepicker__selected-to"):e&&t&&a>=e&&a<=t&&s.classList.add("rangepicker__selected-between")}if(e){const t=this.element.querySelector(`[data-value="${e.toISOString()}"]`);t&&t.closest(".rangepicker__cell").classList.add("rangepicker__selected-from")}if(t){const e=this.element.querySelector(`[data-value="${t.toISOString()}"]`);e&&e.closest(".rangepicker__cell").classList.add("rangepicker__selected-to")}}renderCalendar(e){const t=new Date(e);t.setDate(1);const s=t.toLocaleString("ru",{month:"long"});let n=`<div class="rangepicker__calendar">\n      <div class="rangepicker__month-indicator">\n        <time datetime=${s}>${s}</time>\n      </div>\n      <div class="rangepicker__day-of-week">\n        <div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div>\n      </div>\n      <div class="rangepicker__date-grid">\n    `;var a;for(n+=`\n      <button type="button"\n        class="rangepicker__cell"\n        data-value="${t.toISOString()}"\n        style="--start-from: ${a=t.getDay(),1+(0===a?6:a-1)}">\n          ${t.getDate()}\n      </button>`,t.setDate(2);t.getMonth()===e.getMonth();)n+=`\n        <button type="button"\n          class="rangepicker__cell"\n          data-value="${t.toISOString()}">\n            ${t.getDate()}\n        </button>`,t.setDate(t.getDate()+1);return n+="</div></div>",n}onRangePickerCellClick(e){const{value:t}=e.dataset;if(t){const e=new Date(t);this.selectingFrom?(this.selected={from:e,to:null},this.selectingFrom=!1,this.renderHighlight()):(e>this.selected.from?this.selected.to=e:(this.selected.to=this.selected.from,this.selected.from=e),this.selectingFrom=!0,this.renderHighlight()),this.selected.from&&this.selected.to&&(this.dispatchEvent(),this.close(),this.subElements.from.innerHTML=a.formatDate(this.selected.from),this.subElements.to.innerHTML=a.formatDate(this.selected.to))}}dispatchEvent(){this.element.dispatchEvent(new CustomEvent("date-select",{bubbles:!0,detail:this.selected}))}remove(){this.element.remove(),document.removeEventListener("click",this.onDocumentClick,!0)}destroy(){return this.remove(),this.element=null,this.subElements={},this.selectingFrom=!0,this.selected={from:new Date,to:new Date},this}}}]]);
//# sourceMappingURL=dashboard-index-js.js.map